{% extends layout %}

{% form_theme form 'AppBundle:Form:menu.html.twig' %}

{% block breadcrumb %}
<li><a href="{{ path(restaurants_route) }}">{% trans %}Restaurants{% endtrans %}</a></li>
<li><a href="{{ path(restaurant_route, { id: restaurant.id }) }}">{{ restaurant.name }}</a></li>
<li>Menu</li>
{% endblock %}

{% block content %}

<h1>
  {{ restaurant.name }}
</h1>
<hr>

{{ form_start(form) }}
  {{ form_row(form.addSection) }}
  <hr>
  {{ form_row(form.hasMenuSection, { attr: { class: 'panel-group', role: 'tablist' } }) }}
  {{ form_widget(form.submit, { attr: { class: 'btn-block btn-primary' } }) }}
{{ form_end(form) }}

{% endblock %}

{% block scripts %}
<script type="text/javascript">

function addForm($container) {

  var prototype = $container.data('prototype');
  var index = $container.children().length;

  var form = prototype.replace(/__name__/g, index);
  var $form = $(form);

  $container.append($form);
}

var addSectionURL = "{{ path('admin_restaurant_menu_add_section', { id: restaurant.id }) }}"

$(function() {

  $(document).on('click', '.list-group-item .close', function(e) {
    e.preventDefault();
    $(e.target).closest('.list-group-item').remove();
  });

  $(document).on('click', '[data-toggle="add-menu-item"]', function(e) {
    e.preventDefault();
    var selector = $(e.target).data('target');
    var $target = $(selector);
    addForm($target);
  });

  $(document).on('click', '[data-toggle="remove-menu-section"]', function(e) {
    e.preventDefault();
    var selector = $(e.target).data('target');
    var $target = $(selector);
    $target.remove();
  });

  $('#add-menu-section').on('click', function(e) {
    e.preventDefault();
    var $form = $(this).closest('form');

    $(this).attr('disabled', true);
    $form.find('[type="submit"]').attr('disabled', true);

    $.ajax({
      url : addSectionURL,
      type: $form.attr('method'),
      data : $form.serialize(),
      success: function(html) {

        $(this).removeAttr('disabled');
        $form.find('[type="submit"]').removeAttr('disabled');

        $('#menu_hasMenuSection').replaceWith(
          $(html).find('#menu_hasMenuSection')
        );
      }
    });
  });

});
</script>
{% endblock %}
